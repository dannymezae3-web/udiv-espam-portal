<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recuperar Contraseña - UDIV ESPAM MFL</title>
    <link rel="stylesheet" href="css/login.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Fuentes institucionales ESPAM MFL -->
    <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="icon" href="images/favicon.ico" type="image/x-icon">
    <style>
        /* Variables de colores ESPAM MFL */
        :root {
            --espam-primary: #005846;    /* Verde principal */
            --espam-secondary: #39b54a;   /* Verde secundario */
            --espam-accent: #cbdb2a;      /* Amarillo-verde */
            --espam-light: #08b89d;       /* Verde claro */
            --espam-bg-light: #F8F8F2;    /* Fondo claro */
            --espam-font-primary: 'Libertad Mono', 'Work Sans', monospace;
            --espam-font-secondary: 'Work Sans', sans-serif;
        }

        /* Estilos generales con identidad ESPAM */
        body {
            font-family: var(--espam-font-secondary);
            background: linear-gradient(135deg, #004637 0%, var(--espam-primary) 100%);
            color: #333;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .login-container {
            width: 100%;
            max-width: 450px;
            margin: 20px;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header ESPAM */
        .login-header {
            background: linear-gradient(135deg, var(--espam-primary) 0%, #004637 100%);
            color: white;
            text-align: center;
            padding: 25px;
            border-radius: 10px 10px 0 0;
            box-shadow: 0 4px 12px rgba(0, 88, 70, 0.2);
            margin-bottom: 0;
        }

        .login-logo {
            max-height: 70px;
            margin-bottom: 15px;
            filter: brightness(0) invert(1);
        }

        .login-header h1 {
            font-family: var(--espam-font-primary);
            font-weight: bold;
            font-size: 1.5rem;
            margin: 0 0 5px 0;
            color: white;
        }

        .login-header p {
            font-family: var(--espam-font-secondary);
            opacity: 0.9;
            margin: 0;
            font-size: 0.9rem;
        }

        /* Caja de recuperación ESPAM */
        .login-box {
            background: white;
            padding: 30px;
            border-radius: 0 0 10px 10px;
            box-shadow: 0 6px 20px rgba(0, 88, 70, 0.15);
            font-family: var(--espam-font-secondary);
        }

        .login-box h2 {
            color: var(--espam-primary);
            text-align: center;
            margin: 0 0 25px 0;
            font-family: var(--espam-font-primary);
            font-weight: bold;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* Pasos de recuperación ESPAM */
        .recovery-steps {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
            position: relative;
        }

        .recovery-steps::before {
            content: '';
            position: absolute;
            top: 15px;
            left: 10%;
            right: 10%;
            height: 2px;
            background-color: var(--espam-bg-light);
            z-index: 1;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            flex: 1;
        }

        .step-number {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background-color: var(--espam-bg-light);
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-family: var(--espam-font-primary);
            margin-bottom: 8px;
            transition: all 0.3s;
            border: 2px solid var(--espam-bg-light);
        }

        .step.active .step-number {
            background-color: var(--espam-primary);
            color: white;
            border-color: var(--espam-primary);
        }

        .step.completed .step-number {
            background-color: var(--espam-secondary);
            color: white;
            border-color: var(--espam-secondary);
        }

        .step-text {
            font-size: 0.8rem;
            color: #666;
            text-align: center;
            font-family: var(--espam-font-secondary);
            font-weight: 500;
        }

        .step.active .step-text {
            color: var(--espam-primary);
            font-weight: 600;
        }

        /* Pasos de recuperación */
        .recovery-step {
            display: none;
        }

        .recovery-step.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .recovery-step p {
            color: #666;
            text-align: center;
            margin-bottom: 25px;
            font-family: var(--espam-font-secondary);
            line-height: 1.5;
        }

        /* Formularios ESPAM */
        .form-group {
            margin-bottom: 25px;
        }

        .form-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            color: var(--espam-primary);
            font-weight: 600;
            font-family: var(--espam-font-secondary);
        }

        .form-group label i {
            font-size: 1.1rem;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 14px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-family: var(--espam-font-secondary);
            font-size: 1rem;
            transition: all 0.3s;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--espam-primary);
            box-shadow: 0 0 0 3px rgba(0, 88, 70, 0.1);
        }

        /* Inputs de código */
        .code-inputs {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .code-input {
            width: 50px !important;
            height: 60px;
            text-align: center;
            font-size: 1.5rem;
            font-weight: bold;
            font-family: var(--espam-font-primary);
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .code-input:focus {
            border-color: var(--espam-primary);
            box-shadow: 0 0 0 3px rgba(0, 88, 70, 0.1);
            transform: scale(1.05);
        }

        /* Temporizador */
        .timer {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin: 20px 0;
            color: var(--espam-accent);
            font-weight: 600;
            font-family: var(--espam-font-primary);
        }

        .timer i {
            font-size: 1.2rem;
        }

        /* Botones ESPAM */
        .btn-next, .btn-prev, .btn-register-submit, .btn-primary {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-family: var(--espam-font-primary);
            font-weight: bold;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-next {
            background-color: var(--espam-primary);
            color: white;
        }

        .btn-next:hover {
            background-color: #004637;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 88, 70, 0.2);
        }

        .btn-prev {
            background-color: #f8f9fa;
            color: var(--espam-primary);
            border: 2px solid var(--espam-primary);
        }

        .btn-prev:hover {
            background-color: var(--espam-primary);
            color: white;
        }

        .btn-register-submit {
            background-color: var(--espam-secondary);
            color: white;
        }

        .btn-register-submit:hover {
            background-color: #2da341;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(57, 181, 74, 0.2);
        }

        .btn-primary {
            background-color: var(--espam-primary);
            color: white;
            text-decoration: none;
            display: inline-flex;
            width: auto;
            padding: 12px 30px;
            margin-top: 20px;
        }

        .btn-primary:hover {
            background-color: #004637;
        }

        .form-buttons {
            display: flex;
            gap: 15px;
            margin-top: 30px;
        }

        .form-buttons button {
            flex: 1;
        }

        /* Enlaces de recuperación */
        .recovery-links {
            text-align: center;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid var(--espam-bg-light);
        }

        .recovery-links a {
            color: var(--espam-primary);
            text-decoration: none;
            font-weight: 600;
            font-family: var(--espam-font-secondary);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .recovery-links a:hover {
            color: var(--espam-secondary);
            transform: translateX(-5px);
        }

        /* Reenviar código */
        .resend-code {
            text-align: center;
            margin-top: 20px;
            color: #666;
            font-family: var(--espam-font-secondary);
        }

        .resend-code a {
            color: var(--espam-primary);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s;
        }

        .resend-code a:hover {
            color: var(--espam-secondary);
        }

        /* Requisitos de contraseña */
        .password-requirements {
            background-color: var(--espam-bg-light);
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            font-family: var(--espam-font-secondary);
        }

        .password-requirements p {
            margin: 0 0 10px 0;
            color: var(--espam-primary);
            font-weight: 600;
            font-size: 0.9rem;
        }

        .password-requirements ul {
            margin: 0;
            padding-left: 20px;
            font-size: 0.85rem;
            color: #666;
        }

        .password-requirements li {
            margin-bottom: 5px;
            transition: all 0.3s;
        }

        .password-requirements li.valid {
            color: var(--espam-secondary);
        }

        .password-requirements li.valid::before {
            content: '✓ ';
            color: var(--espam-secondary);
        }

        .password-requirements li.invalid {
            color: #dc3545;
        }

        .password-requirements li.invalid::before {
            content: '✗ ';
            color: #dc3545;
        }

        /* Estado de coincidencia de contraseña */
        .match-status {
            margin-top: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            padding: 5px 10px;
            border-radius: 4px;
            display: none;
        }

        .match-status.match {
            background-color: rgba(57, 181, 74, 0.1);
            color: var(--espam-secondary);
            display: block;
        }

        .match-status.no-match {
            background-color: rgba(220, 53, 69, 0.1);
            color: #dc3545;
            display: block;
        }

        /* Mensaje de éxito ESPAM */
        .success-message {
            text-align: center;
            padding: 30px;
            animation: fadeIn 0.5s ease;
        }

        .success-icon {
            font-size: 4rem;
            color: var(--espam-secondary);
            margin-bottom: 20px;
            animation: bounce 1s ease;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {transform: translateY(0);}
            40% {transform: translateY(-20px);}
            60% {transform: translateY(-10px);}
        }

        .success-message h3 {
            color: var(--espam-primary);
            font-family: var(--espam-font-primary);
            font-weight: bold;
            margin: 0 0 15px 0;
            font-size: 1.5rem;
        }

        .success-message p {
            color: #666;
            margin: 0 0 10px 0;
            font-family: var(--espam-font-secondary);
            line-height: 1.5;
        }

        /* Información de ayuda ESPAM */
        .login-info {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            padding: 25px;
            margin-top: 25px;
            box-shadow: 0 4px 12px rgba(0, 88, 70, 0.1);
            border-left: 5px solid var(--espam-accent);
        }

        .login-info h3 {
            color: var(--espam-primary);
            margin: 0 0 15px 0;
            font-family: var(--espam-font-primary);
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .login-info ul {
            margin: 0;
            padding-left: 20px;
            font-family: var(--espam-font-secondary);
        }

        .login-info li {
            margin-bottom: 10px;
            color: #666;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .login-info li:last-child {
            margin-bottom: 0;
            color: var(--espam-primary);
            font-weight: 600;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .login-container {
                margin: 10px;
            }
            
            .login-box {
                padding: 20px;
            }
            
            .form-buttons {
                flex-direction: column;
            }
            
            .code-input {
                width: 40px !important;
                height: 50px;
                font-size: 1.2rem;
            }
            
            .step-text {
                font-size: 0.7rem;
            }
        }

        @media (max-width: 480px) {
            .login-header {
                padding: 20px;
            }
            
            .login-header h1 {
                font-size: 1.3rem;
            }
            
            .login-box h2 {
                font-size: 1.2rem;
            }
            
            .code-inputs {
                gap: 5px;
            }
            
            .code-input {
                width: 35px !important;
                height: 45px;
            }
            
            .step-number {
                width: 25px;
                height: 25px;
                font-size: 0.9rem;
            }
        }

        /* Logo ESPAM alternativo */
        .login-logo[src*="logo-espam.png"] {
            font-family: 'Libertad Mono', monospace;
            font-size: 1.8rem;
            font-weight: bold;
            color: white;
            filter: none;
        }

        /* Iconos con colores ESPAM */
        .fa-key, .fa-envelope, .fa-user-tag, .fa-shield-alt, 
        .fa-paper-plane, .fa-arrow-left, .fa-check, .fa-lock, 
        .fa-save, .fa-sign-in-alt, .fa-question-circle, .fa-clock {
            color: var(--espam-primary);
        }

        .fa-check-circle {
            color: var(--espam-secondary);
        }

        /* Placeholder styling */
        ::placeholder {
            color: #999;
            font-family: var(--espam-font-secondary);
        }
    </style>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-client.js"></script>
</head>
<body>
    <div class="login-container">
        <div class="login-header">
            <!-- Logo ESPAM MFL -->
            <div class="login-logo" style="font-family: 'Libertad Mono', monospace; font-size: 1.8rem; font-weight: bold; color: white;">
                ESPAM MFL
            </div>
            <h1>UDIV ESPAM MFL</h1>
            <p>Portal de Gestión de Laboratorios</p>
        </div>

        <div class="login-box">
            <h2><i class="fas fa-key"></i> Recuperar Contraseña</h2>
            
            <div class="recovery-steps">
                <div class="step active" id="stepIndicator1">
                    <span class="step-number">1</span>
                    <span class="step-text">Verificar Email</span>
                </div>
                <div class="step" id="stepIndicator2">
                    <span class="step-number">2</span>
                    <span class="step-text">Código de Verificación</span>
                </div>
                <div class="step" id="stepIndicator3">
                    <span class="step-number">3</span>
                    <span class="step-text">Nueva Contraseña</span>
                </div>
            </div>

            <!-- Paso 1: Verificar Email -->
            <div id="step1" class="recovery-step active">
                <p style="font-family: var(--espam-font-secondary);">
                    Ingrese su correo institucional o personal para recuperar su contraseña.
                </p>
                
                <form id="recoveryForm1">
                    <div class="form-group">
                        <label for="recoveryEmail">
                            <i class="fas fa-envelope"></i> Correo Electrónico *
                        </label>
                        <input type="email" id="recoveryEmail" name="recoveryEmail" 
                               placeholder="usuario@espam.edu.ec" required
                               style="font-family: var(--espam-font-secondary);">
                    </div>

                    <div class="form-group">
                        <label for="userTypeRecovery">
                            <i class="fas fa-user-tag"></i> Tipo de Usuario *
                        </label>
                        <select id="userTypeRecovery" name="userTypeRecovery" required
                                style="font-family: var(--espam-font-secondary);">
                            <option value="">Seleccionar rol</option>
                            <option value="tecnico">Técnico Encargado</option>
                            <option value="docente">Docente ESPAM</option>
                            <option value="estudiante">Estudiante ESPAM</option>
                        </select>
                    </div>

                    <button type="button" class="btn-next" onclick="nextRecoveryStep(2)">
                        <i class="fas fa-paper-plane"></i> Enviar Código de Verificación
                    </button>

                    <div class="recovery-links">
                        <a href="login.html" style="font-family: var(--espam-font-secondary);">
                            <i class="fas fa-arrow-left"></i> Volver al Login
                        </a>
                    </div>
                </form>
            </div>

            <!-- Paso 2: Código de Verificación -->
            <div id="step2" class="recovery-step">
                <p style="font-family: var(--espam-font-secondary);">
                    Hemos enviado un código de verificación a su correo. 
                    Ingrese el código de 6 dígitos recibido.
                </p>
                
                <form id="recoveryForm2">
                    <div class="form-group">
                        <label for="verificationCode">
                            <i class="fas fa-shield-alt"></i> Código de Verificación *
                        </label>
                        <div class="code-inputs">
                            <input type="text" maxlength="1" class="code-input" data-index="1" 
                                   style="font-family: var(--espam-font-primary);">
                            <input type="text" maxlength="1" class="code-input" data-index="2"
                                   style="font-family: var(--espam-font-primary);">
                            <input type="text" maxlength="1" class="code-input" data-index="3"
                                   style="font-family: var(--espam-font-primary);">
                            <input type="text" maxlength="1" class="code-input" data-index="4"
                                   style="font-family: var(--espam-font-primary);">
                            <input type="text" maxlength="1" class="code-input" data-index="5"
                                   style="font-family: var(--espam-font-primary);">
                            <input type="text" maxlength="1" class="code-input" data-index="6"
                                   style="font-family: var(--espam-font-primary);">
                        </div>
                        <input type="hidden" id="fullCode" name="verificationCode">
                    </div>

                    <div class="timer">
                        <i class="fas fa-clock"></i>
                        <span id="countdown" style="font-family: var(--espam-font-primary);">02:00</span>
                    </div>

                    <div class="form-buttons">
                        <button type="button" class="btn-prev" onclick="prevRecoveryStep(1)">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button type="button" class="btn-next" onclick="nextRecoveryStep(3)">
                            Verificar Código <i class="fas fa-check"></i>
                        </button>
                    </div>

                    <div class="resend-code">
                        <p style="font-family: var(--espam-font-secondary);">
                            ¿No recibió el código? 
                            <a href="#" id="resendLink" onclick="resendCode()" 
                               style="font-family: var(--espam-font-secondary);">
                                Reenviar código
                            </a>
                        </p>
                    </div>
                </form>
            </div>

            <!-- Paso 3: Nueva Contraseña -->
            <div id="step3" class="recovery-step">
                <p style="font-family: var(--espam-font-secondary);">
                    Cree una nueva contraseña segura para su cuenta.
                </p>
                
                <form id="recoveryForm3">
                    <div class="form-group">
                        <label for="newPassword">
                            <i class="fas fa-lock"></i> Nueva Contraseña *
                        </label>
                        <input type="password" id="newPassword" name="newPassword" required
                               style="font-family: var(--espam-font-secondary);">
                        <div class="password-requirements">
                            <p><small style="font-family: var(--espam-font-secondary);">La contraseña debe contener:</small></p>
                            <ul>
                                <li id="req-length" style="font-family: var(--espam-font-secondary);">Mínimo 8 caracteres</li>
                                <li id="req-uppercase" style="font-family: var(--espam-font-secondary);">Una letra mayúscula</li>
                                <li id="req-lowercase" style="font-family: var(--espam-font-secondary);">Una letra minúscula</li>
                                <li id="req-number" style="font-family: var(--espam-font-secondary);">Un número</li>
                                <li id="req-special" style="font-family: var(--espam-font-secondary);">Un carácter especial</li>
                            </ul>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="confirmNewPassword">
                            <i class="fas fa-lock"></i> Confirmar Nueva Contraseña *
                        </label>
                        <input type="password" id="confirmNewPassword" name="confirmNewPassword" required
                               style="font-family: var(--espam-font-secondary);">
                        <div id="passwordMatch" class="match-status"></div>
                    </div>

                    <div class="form-buttons">
                        <button type="button" class="btn-prev" onclick="prevRecoveryStep(2)">
                            <i class="fas fa-arrow-left"></i> Anterior
                        </button>
                        <button type="submit" class="btn-register-submit">
                            <i class="fas fa-save"></i> Guardar Nueva Contraseña
                        </button>
                    </div>
                </form>
            </div>

            <!-- Mensaje de éxito -->
            <div id="successMessage" class="success-message" style="display: none;">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h3 style="font-family: var(--espam-font-primary);">¡Contraseña Actualizada!</h3>
                <p style="font-family: var(--espam-font-secondary);">Su contraseña ha sido cambiada exitosamente.</p>
                <p style="font-family: var(--espam-font-secondary);">Ahora puede iniciar sesión con su nueva contraseña.</p>
                <a href="login.html" class="btn-primary" style="font-family: var(--espam-font-primary);">
                    <i class="fas fa-sign-in-alt"></i> Ir al Login
                </a>
            </div>
        </div>

        <div class="login-info">
            <h3><i class="fas fa-question-circle"></i> Ayuda</h3>
            <ul>
                <li style="font-family: var(--espam-font-secondary);">Si no recuerda su correo, contacte al administrador del sistema</li>
                <li style="font-family: var(--espam-font-secondary);">El código de verificación expira en 2 minutos</li>
                <li style="font-family: var(--espam-font-secondary);">Revise su carpeta de spam si no encuentra el correo</li>
                <li style="font-family: var(--espam-font-secondary);">Para problemas técnicos: soporte.labs@espam.edu.ec</li>
            </ul>
        </div>
    </div>

    <script>
        // Variables globales
        let recoveryStep = 1;
        let countdownInterval;
        let countdownTime = 120; // 2 minutos en segundos

        // Inicializar cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            // Configurar inputs de código
            setupCodeInputs();
            
            // Configurar validación de contraseña
            setupPasswordValidation();
            
            // Aplicar tipografía a elementos dinámicos
            document.querySelectorAll('input, select, textarea').forEach(el => {
                el.style.fontFamily = 'var(--espam-font-secondary)';
            });
        });

        // Función para configurar inputs de código
        function setupCodeInputs() {
            const codeInputs = document.querySelectorAll('.code-input');
            
            codeInputs.forEach(input => {
                input.addEventListener('input', function(e) {
                    const value = e.target.value;
                    const index = parseInt(this.dataset.index);
                    
                    // Solo permitir números
                    if (!/^\d*$/.test(value)) {
                        this.value = '';
                        return;
                    }
                    
                    // Si hay valor, pasar al siguiente input
                    if (value && index < 6) {
                        const nextInput = document.querySelector(`.code-input[data-index="${index + 1}"]`);
                        if (nextInput) nextInput.focus();
                    }
                    
                    // Actualizar código completo
                    updateFullCode();
                });
                
                input.addEventListener('keydown', function(e) {
                    // Si es backspace y está vacío, ir al anterior
                    if (e.key === 'Backspace' && !this.value && this.dataset.index > 1) {
                        const prevInput = document.querySelector(`.code-input[data-index="${parseInt(this.dataset.index) - 1}"]`);
                        if (prevInput) prevInput.focus();
                    }
                });
            });
        }

        // Función para actualizar el código completo
        function updateFullCode() {
            let fullCode = '';
            document.querySelectorAll('.code-input').forEach(input => {
                fullCode += input.value;
            });
            document.getElementById('fullCode').value = fullCode;
        }

        // Función para configurar validación de contraseña
        function setupPasswordValidation() {
            const passwordInput = document.getElementById('newPassword');
            const confirmInput = document.getElementById('confirmNewPassword');
            
            if (passwordInput) {
                passwordInput.addEventListener('input', validatePassword);
            }
            
            if (confirmInput) {
                confirmInput.addEventListener('input', validatePasswordMatch);
            }
        }

        // Función para validar requisitos de contraseña
        function validatePassword() {
            const password = this.value;
            
            // Validar longitud
            const lengthValid = password.length >= 8;
            toggleRequirement('req-length', lengthValid);
            
            // Validar mayúscula
            const uppercaseValid = /[A-Z]/.test(password);
            toggleRequirement('req-uppercase', uppercaseValid);
            
            // Validar minúscula
            const lowercaseValid = /[a-z]/.test(password);
            toggleRequirement('req-lowercase', lowercaseValid);
            
            // Validar número
            const numberValid = /\d/.test(password);
            toggleRequirement('req-number', numberValid);
            
            // Validar carácter especial
            const specialValid = /[!@#$%^&*(),.?":{}|<>]/.test(password);
            toggleRequirement('req-special', specialValid);
        }

        // Función para alternar estado de requisito
        function toggleRequirement(elementId, isValid) {
            const element = document.getElementById(elementId);
            if (element) {
                element.classList.remove('valid', 'invalid');
                element.classList.add(isValid ? 'valid' : 'invalid');
            }
        }

        // Función para validar coincidencia de contraseñas
        function validatePasswordMatch() {
            const password = document.getElementById('newPassword').value;
            const confirmPassword = this.value;
            const matchStatus = document.getElementById('passwordMatch');
            
            if (!password || !confirmPassword) {
                matchStatus.className = 'match-status';
                matchStatus.textContent = '';
                return;
            }
            
            if (password === confirmPassword) {
                matchStatus.className = 'match-status match';
                matchStatus.textContent = '✓ Las contraseñas coinciden';
            } else {
                matchStatus.className = 'match-status no-match';
                matchStatus.textContent = '✗ Las contraseñas no coinciden';
            }
        }

        // Función para avanzar al siguiente paso
        function nextRecoveryStep(nextStep) {
            // Validar paso actual
            if (!validateCurrentStep(recoveryStep)) {
                return;
            }
            
            // Ocultar paso actual
            document.getElementById(`step${recoveryStep}`).classList.remove('active');
            document.getElementById(`stepIndicator${recoveryStep}`).classList.remove('active');
            
            // Marcar paso como completado
            document.getElementById(`stepIndicator${recoveryStep}`).classList.add('completed');
            
            // Actualizar paso
            recoveryStep = nextStep;
            
            // Mostrar siguiente paso
            document.getElementById(`step${recoveryStep}`).classList.add('active');
            document.getElementById(`stepIndicator${recoveryStep}`).classList.add('active');
            
            // Iniciar temporizador si es el paso 2
            if (recoveryStep === 2) {
                startCountdown();
            }
            
            // Reiniciar temporizador si es otro paso
            if (recoveryStep !== 2 && countdownInterval) {
                clearInterval(countdownInterval);
            }
        }

        // Función para retroceder al paso anterior
        function prevRecoveryStep(prevStep) {
            // Ocultar paso actual
            document.getElementById(`step${recoveryStep}`).classList.remove('active');
            document.getElementById(`stepIndicator${recoveryStep}`).classList.remove('active');
            
            // Remover estado completado del paso actual
            document.getElementById(`stepIndicator${recoveryStep}`).classList.remove('completed');
            
            // Actualizar paso
            recoveryStep = prevStep;
            
            // Mostrar paso anterior
            document.getElementById(`step${recoveryStep}`).classList.add('active');
            document.getElementById(`stepIndicator${recoveryStep}`).classList.add('active');
            
            // Reiniciar temporizador
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            if (recoveryStep === 2) {
                startCountdown();
            }
        }

        // Función para validar el paso actual
        function validateCurrentStep(step) {
            switch(step) {
                case 1:
                    const email = document.getElementById('recoveryEmail').value;
                    const userType = document.getElementById('userTypeRecovery').value;
                    
                    if (!email || !userType) {
                        showNotification('Por favor complete todos los campos', 'warning');
                        return false;
                    }
                    
                    if (!isValidEmail(email)) {
                        showNotification('Ingrese un correo electrónico válido', 'warning');
                        return false;
                    }
                    
                    // Simular envío de código
                    showNotification(`Código de verificación enviado a ${email}`, 'success');
                    return true;
                    
                case 2:
                    const code = document.getElementById('fullCode').value;
                    
                    if (code.length !== 6) {
                        showNotification('Ingrese el código de 6 dígitos completo', 'warning');
                        return false;
                    }
                    
                    // Simular verificación de código (en producción, se verificaría con el servidor)
                    if (code === '123456') { // Código de prueba
                        showNotification('Código verificado correctamente', 'success');
                        return true;
                    } else {
                        showNotification('Código incorrecto. Intente nuevamente.', 'error');
                        return false;
                    }
                    
                case 3:
                    const password = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmNewPassword').value;
                    
                    if (!password || !confirmPassword) {
                        showNotification('Por favor complete todos los campos', 'warning');
                        return false;
                    }
                    
                    if (password !== confirmPassword) {
                        showNotification('Las contraseñas no coinciden', 'warning');
                        return false;
                    }
                    
                    // Validar requisitos de contraseña
                    const requirements = [
                        password.length >= 8,
                        /[A-Z]/.test(password),
                        /[a-z]/.test(password),
                        /\d/.test(password),
                        /[!@#$%^&*(),.?":{}|<>]/.test(password)
                    ];
                    
                    if (requirements.every(req => req)) {
                        // Simular cambio de contraseña
                        setTimeout(() => {
                            showSuccessMessage();
                        }, 1000);
                        return true;
                    } else {
                        showNotification('La contraseña no cumple con todos los requisitos', 'warning');
                        return false;
                    }
                    
                default:
                    return false;
            }
        }

        // Función para verificar email válido
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Función para iniciar temporizador
        function startCountdown() {
            countdownTime = 120; // Reiniciar a 2 minutos
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
            }
            
            updateCountdownDisplay();
            
            countdownInterval = setInterval(() => {
                countdownTime--;
                updateCountdownDisplay();
                
                if (countdownTime <= 0) {
                    clearInterval(countdownInterval);
                    showNotification('El código ha expirado. Solicite uno nuevo.', 'warning');
                    document.getElementById('resendLink').style.display = 'inline';
                }
            }, 1000);
        }

        // Función para actualizar display del temporizador
        function updateCountdownDisplay() {
            const minutes = Math.floor(countdownTime / 60);
            const seconds = countdownTime % 60;
            const countdownDisplay = document.getElementById('countdown');
            
            if (countdownDisplay) {
                countdownDisplay.textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                // Cambiar color cuando falten 30 segundos
                if (countdownTime <= 30) {
                    countdownDisplay.style.color = '#dc3545';
                } else if (countdownTime <= 60) {
                    countdownDisplay.style.color = 'var(--espam-accent)';
                } else {
                    countdownDisplay.style.color = 'var(--espam-primary)';
                }
            }
        }

        // Función para reenviar código
        function resendCode() {
            const email = document.getElementById('recoveryEmail').value;
            
            if (!email) {
                showNotification('Por favor ingrese su correo electrónico', 'warning');
                return;
            }
            
            // Simular reenvío
            showNotification(`Código reenviado a ${email}`, 'success');
            
            // Reiniciar temporizador
            startCountdown();
            
            // Limpiar inputs de código
            document.querySelectorAll('.code-input').forEach(input => {
                input.value = '';
            });
            updateFullCode();
            
            // Enfocar primer input
            const firstInput = document.querySelector('.code-input[data-index="1"]');
            if (firstInput) firstInput.focus();
            
            // Ocultar enlace de reenvío temporalmente
            const resendLink = document.getElementById('resendLink');
            resendLink.style.display = 'none';
            setTimeout(() => {
                resendLink.style.display = 'inline';
            }, 30000); // Mostrar después de 30 segundos
        }

        // Función para mostrar mensaje de éxito
        function showSuccessMessage() {
            // Ocultar paso actual
            document.getElementById(`step${recoveryStep}`).style.display = 'none';
            document.getElementById('recoveryForm3').reset();
            
            // Mostrar mensaje de éxito
            const successMessage = document.getElementById('successMessage');
            successMessage.style.display = 'block';
            
            // Mostrar notificación
            showNotification('¡Contraseña cambiada exitosamente!', 'success');
        }

        // Función para mostrar notificaciones
        function showNotification(message, type) {
            // Crear elemento de notificación
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-family: var(--espam-font-secondary);
                font-weight: 600;
                background: ${type === 'success' ? 'var(--espam-secondary)' : 
                           type === 'warning' ? 'var(--espam-accent)' : '#dc3545'};
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideIn 0.3s ease;
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 400px;
                border-left: 4px solid ${type === 'success' ? '#2da341' : 
                                 type === 'warning' ? '#b9c925' : '#bd2130'};
            `;
            
            const icon = type === 'success' ? 'fas fa-check-circle' :
                        type === 'warning' ? 'fas fa-exclamation-triangle' :
                        'fas fa-exclamation-circle';
            
            notification.innerHTML = `
                <i class="${icon}" style="font-size: 1.2rem;"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(notification);
            
            // Eliminar después de 5 segundos
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        // Agregar animaciones CSS si no existen
        if (!document.querySelector('style#animations')) {
            const style = document.createElement('style');
            style.id = 'animations';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                @keyframes slideOut {
                    from {
                        transform: translateX(0);
                        opacity: 1;
                    }
                    to {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                }
            `;
            document.head.appendChild(style);
        }
    </script>
</body>
</html>